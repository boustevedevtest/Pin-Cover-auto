<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinterest Poster Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Knewave&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 800;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="file"] {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="file"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .file-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .image-preview {
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            max-height: 150px;
        }

        .image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .btn-generate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-generate:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.5);
        }

        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .result-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 2px solid #e2e8f0;
        }

        .result-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        #canvas {
            display: none;
        }

        #preview {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            display: block;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .download-section {
            text-align: center;
            margin-top: 30px;
        }

        .btn-download {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.5);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .file-name {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #4a5568;
            font-style: italic;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-settings {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-settings:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: #2d3748;
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: #a0aec0;
        }

        .btn-post-auto {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(229, 62, 62, 0.4);
            margin-left: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-post-auto:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(229, 62, 62, 0.5);
        }

        .btn-post-auto:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2rem;
            }

            .download-section {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .btn-post-auto {
                margin-left: 0;
            }
        }

        /* Login Screen Styles */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: #2d3748;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1.2rem;
            text-align: center;
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .login-box button:hover {
            background: #764ba2;
        }

        #mainContent {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Password Protection -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: #4b6f44;">üîí Pin Poster Auto</h2>
            <p style="margin-bottom: 20px; color: #718096;">Please enter your access code</p>
            <input type="password" id="passCode" placeholder="Enter Code..." autofocus>
            <button id="loginBtn">Unlock Platform</button>
            <p id="loginError" style="color: #e53e3e; margin-top: 15px; display: none;">Invalid code. Try again.</p>
        </div>
    </div>

    <div id="mainContent" class="container">
        <div class="header-actions">
            <div>
                <h1>üé® Pin Auto Pro</h1>
                <p class="subtitle" style="margin-bottom: 0;">Automate & Design Pinterest Posters</p>
            </div>
            <button class="btn-settings" id="openSettings">
                ‚öôÔ∏è Settings
            </button>
        </div>

        <form id="posterForm">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="title">Title</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="title" placeholder="Enter your pin title..." required style="flex: 1;">
                        <div style="text-align: center;">
                            <input type="color" id="titleColor" value="#4B6F44"
                                style="width: 50px; height: 50px; padding: 2px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                        </div>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="websiteUrl">Website URL (saved automatically) üíæ</label>
                    <input type="text" id="websiteUrl" placeholder="www.omarecipes.com">
                    <small style="color: #718096; margin-top: 5px;">This will be displayed below the title and saved for
                        future use</small>
                </div>

                <div class="form-group">
                    <label>Image 1 (Top Half)</label>
                    <label for="image1" class="file-input-wrapper">
                        üìÅ Choose Image 1
                        <input type="file" id="image1" accept="image/*" required>
                    </label>
                    <div class="file-name" id="file1-name"></div>
                    <div class="image-preview" id="preview1"></div>
                </div>

                <div class="form-group">
                    <label>Image 2 (Bottom Half)</label>
                    <label for="image2" class="file-input-wrapper">
                        üìÅ Choose Image 2
                        <input type="file" id="image2" accept="image/*" required>
                    </label>
                    <div class="file-name" id="file2-name"></div>
                    <div class="image-preview" id="preview2"></div>
                </div>
            </div>

            <button type="submit" class="btn-generate" id="generateBtn">
                Generate Pinterest Poster
            </button>
        </form>

        <div id="loadingIndicator" class="loading" style="display: none;">
            ‚è≥ Generating your stunning poster...
        </div>

        <div id="resultSection" class="result-section" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h2>‚ú® Your Pinterest Poster</h2>
                    <canvas id="canvas" width="1000" height="1500"></canvas>
                    <img id="preview" alt="Generated Poster">
                    <div class="download-section">
                        <a id="downloadBtn" class="btn-download" download="pinterest-poster.jpg">
                            ‚¨áÔ∏è Download JPG
                        </a>
                    </div>
                </div>

                <div id="seoPreviewSection"
                    style="background: #f7fafc; padding: 25px; border-radius: 20px; border: 2px solid #e2e8f0;">
                    <h2 style="font-size: 1.4rem;">ü§ñ AI SEO Content</h2>
                    <p style="font-size: 0.9rem; color: #718096; margin-bottom: 20px;">Review and edit before posting
                    </p>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Pin Title</label>
                        <input type="text" id="seoTitle" style="width: 100%;">
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Description</label>
                        <textarea id="seoDescription"
                            style="width: 100%; height: 120px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: inherit; resize: vertical;"></textarea>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>Hashtags (comma separated)</label>
                        <input type="text" id="seoHashtags" style="width: 100%;">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>Destination Link (URL)</label>
                        <input type="text" id="seoLink"
                            style="width: 100%; border: 2px solid #3182ce; background: #ebf8ff;"
                            placeholder="https://omarecipes.com/recipe-name">
                    </div>

                    <button id="postAutoBtn" class="btn-post-auto" style="width: 100%; margin: 0; padding: 18px;">
                        üöÄ Post to Pinterest Now
                    </button>

                    <div id="postStatus" style="margin-top: 15px; font-weight: 600; text-align: center;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configuration</h2>
                <span class="close-modal" id="closeSettings">&times;</span>
            </div>
            <div class="form-grid" style="grid-template-columns: 1fr; gap: 20px;">
                <div class="form-group">
                    <label>OpenRouter API Key</label>
                    <input type="password" id="openrouterKey" placeholder="sk-or-v1-...">
                </div>
                <div style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; background: #f7fafc;">
                    <label style="color: #e53e3e;">üîë Pinterest Login (Recommended)</label>
                    <div class="form-group" style="margin-top: 10px;">
                        <label>App ID</label>
                        <input type="text" id="pinterestAppId" placeholder="1543552">
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label>App Secret</label>
                        <input type="password" id="pinterestAppSecret" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button id="connectPinterest" class="btn-download"
                        style="width: 100%; margin-top: 15px; background: #e60023;">
                        üî¥ Connect to Pinterest
                    </button>
                    <div id="authStatus" style="font-size: 0.8rem; margin-top: 5px; text-align: center;"></div>
                </div>
                <div class="form-group">
                    <label>Pinterest Access Token (Manual)</label>
                    <input type="password" id="pinterestToken" placeholder="pina_...">
                </div>
                <div class="form-group">
                    <label>Pinterest Board ID</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="pinterestBoard" placeholder="123456..." style="flex: 1;">
                        <button id="btnLoadBoards" class="btn-settings" style="padding: 5px 15px; font-size: 0.8rem;">
                            üîÑ Load
                        </button>
                    </div>
                </div>
                <div class="form-group"
                    style="display: flex; align-items: center; gap: 10px; background: #fff5f5; padding: 10px; border-radius: 8px; border: 1px solid #feb2b2;">
                    <input type="checkbox" id="pinterestSandbox" style="width: auto;">
                    <label style="margin: 0; color: #c53030; font-weight: bold; font-size: 0.9rem;">üõ†Ô∏è Use Pinterest
                        Sandbox (Recommended for Trial Apps)</label>
                </div>
                <div class="form-group">
                    <label>Default Website URL</label>
                    <input type="text" id="defaultUrl" placeholder="www.omarecipes.com">
                </div>
                <div class="form-group">
                    <label>AI Model</label>
                    <input type="text" id="modelSelect" value="google/gemini-2.0-flash-001">
                </div>
                <button id="saveSettings" class="btn-generate">Save Configuration üíæ</button>
            </div>
        </div>
    </div>

    <script>
        // Password Check Logic
        const loginOverlay = document.getElementById('loginOverlay');
        const mainContent = document.getElementById('mainContent');
        const passCodeInput = document.getElementById('passCode');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');

        function checkAuth() {
            if (localStorage.getItem('app_authorized') === '1992') {
                loginOverlay.style.display = 'none';
                mainContent.style.display = 'block';
            }
        }

        loginBtn.onclick = () => {
            if (passCodeInput.value === '1992') {
                localStorage.setItem('app_authorized', '1992');
                loginOverlay.style.display = 'none';
                mainContent.style.display = 'block';
            } else {
                loginError.style.display = 'block';
                passCodeInput.value = '';
                passCodeInput.focus();
            }
        };

        passCodeInput.onkeypress = (e) => {
            if (e.key === 'Enter') loginBtn.onclick();
        };

        checkAuth();

        const form = document.getElementById('posterForm');
        const generateBtn = document.getElementById('generateBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultSection = document.getElementById('resultSection');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const preview = document.getElementById('preview');
        const downloadBtn = document.getElementById('downloadBtn');

        // Design constants
        const CANVAS_WIDTH = 1000;
        const CANVAS_HEIGHT = 1500;
        // const TITLE_COLOR = '#4B6F44'; // Dynamic now
        const BANNER_COLOR = '#FFFFFF';
        const BANNER_HEIGHT = 330;
        const URL_COLOR = '#E07B39'; // Orange color for URL

        // Load saved website URL from localStorage
        const websiteUrlInput = document.getElementById('websiteUrl');
        const defaultUrlInput = document.getElementById('defaultUrl');
        const openrouterKeyInput = document.getElementById('openrouterKey');
        const pinterestTokenInput = document.getElementById('pinterestToken');
        const pinterestBoardInput = document.getElementById('pinterestBoard');
        const modelSelectInput = document.getElementById('modelSelect');
        const pinterestAppIdInput = document.getElementById('pinterestAppId');
        const pinterestAppSecretInput = document.getElementById('pinterestAppSecret');
        const pinterestSandboxInput = document.getElementById('pinterestSandbox');

        // Load settings from localStorage
        function loadSettings() {
            const savedUrl = localStorage.getItem('pinterestGeneratorUrl');
            const savedDefaultUrl = localStorage.getItem('pinterestDefaultUrl');
            const savedORKey = localStorage.getItem('openrouterKey');
            const savedPToken = localStorage.getItem('pinterestToken');
            const savedPBoard = localStorage.getItem('pinterestBoard');
            const savedModel = localStorage.getItem('openrouterModel');
            const savedAppId = localStorage.getItem('pinterestAppId');
            const savedAppSecret = localStorage.getItem('pinterestAppSecret');
            const savedSandbox = localStorage.getItem('pinterestSandbox') === 'true';

            if (savedUrl) websiteUrlInput.value = savedUrl;
            if (savedDefaultUrl) defaultUrlInput.value = savedDefaultUrl;
            if (savedORKey) openrouterKeyInput.value = savedORKey;
            if (savedPToken) pinterestTokenInput.value = savedPToken;
            if (savedPBoard) pinterestBoardInput.value = savedPBoard;
            if (savedModel) modelSelectInput.value = savedModel;
            if (savedAppId) pinterestAppIdInput.value = savedAppId;
            if (savedAppSecret) pinterestAppSecretInput.value = savedAppSecret;
            pinterestSandboxInput.checked = savedSandbox;

            // If website URL is empty but default exists, use default
            if (!websiteUrlInput.value && savedDefaultUrl) {
                websiteUrlInput.value = savedDefaultUrl;
            }
        }

        loadSettings();

        // Modal Logic
        const modal = document.getElementById('settingsModal');
        document.getElementById('openSettings').onclick = () => modal.style.display = 'flex';
        document.getElementById('closeSettings').onclick = () => modal.style.display = 'none';
        window.onclick = (e) => { if (e.target == modal) modal.style.display = 'none'; };

        document.getElementById('saveSettings').onclick = () => {
            localStorage.setItem('pinterestDefaultUrl', defaultUrlInput.value);
            localStorage.setItem('openrouterKey', openrouterKeyInput.value);
            localStorage.setItem('pinterestToken', pinterestTokenInput.value);
            localStorage.setItem('pinterestBoard', pinterestBoardInput.value);
            localStorage.setItem('openrouterModel', modelSelectInput.value);
            localStorage.setItem('pinterestAppId', pinterestAppIdInput.value);
            localStorage.setItem('pinterestAppSecret', pinterestAppSecretInput.value);
            localStorage.setItem('pinterestSandbox', pinterestSandboxInput.checked);
            modal.style.display = 'none';
            alert('Settings saved! üíæ');
        };

        // Pinterest Auth Popup
        document.getElementById('connectPinterest').onclick = () => {
            const appId = pinterestAppIdInput.value.trim();
            const appSecret = pinterestAppSecretInput.value.trim();

            if (!appId || !appSecret) {
                alert('Please enter your App ID and App Secret first!');
                return;
            }

            // Save them
            localStorage.setItem('pinterestAppId', appId);
            localStorage.setItem('pinterestAppSecret', appSecret);

            // Open auth window (Pass secret to server so it can exchange token)
            const sandbox = pinterestSandboxInput.checked;
            const authUrl = `${window.location.origin}/auth/pinterest?client_id=${appId}&client_secret=${appSecret}&sandbox=${sandbox}`;
            window.open(authUrl, 'Pinterest Auth', 'width=600,height=700');
        };

        // Listen for token from popup
        window.addEventListener('message', (event) => {
            if (event.data.type === 'PINTEREST_TOKEN') {
                pinterestTokenInput.value = event.data.token;
                localStorage.setItem('pinterestToken', event.data.token);
                document.getElementById('authStatus').innerHTML = '‚úÖ Connected successfully!';
                document.getElementById('authStatus').style.color = '#38a169';

                // Automatically try to load boards
                loadPinterestBoards(event.data.token);

                alert('Pinterest connected! Scopes: pins:write active ‚úÖ');
            }
        });

        async function loadPinterestBoards(token) {
            const btn = document.getElementById('btnLoadBoards');
            const statusDiv = document.getElementById('authStatus');
            if (btn) btn.innerHTML = '‚è≥...';

            try {
                const sandbox = pinterestSandboxInput.checked;
                const response = await fetch(`${window.location.origin}/api/list-boards?token=${token}&sandbox=${sandbox}`);
                const result = await response.json();

                if (result.success && result.boards && result.boards.length > 0) {
                    // Create a small dropdown if multiple boards
                    let selectHtml = `<select id="boardPicker" style="margin-top:10px; padding:8px; border-radius:8px; width:100%;">`;
                    result.boards.forEach(b => {
                        selectHtml += `<option value="${b.id}" ${b.id === pinterestBoardInput.value ? 'selected' : ''}>${b.name}</option>`;
                    });
                    selectHtml += `</select>`;

                    if (statusDiv) {
                        statusDiv.innerHTML = `‚úÖ ${result.boards.length} Boards loaded!<br>` + selectHtml;
                        statusDiv.style.color = '#38a169';

                        document.getElementById('boardPicker').onchange = (e) => {
                            pinterestBoardInput.value = e.target.value;
                            localStorage.setItem('pinterestBoard', e.target.value);
                        };
                        // Set first board if empty
                        if (!pinterestBoardInput.value) {
                            pinterestBoardInput.value = result.boards[0].id;
                            localStorage.setItem('pinterestBoard', result.boards[0].id);
                        }
                    }
                    if (btn) btn.innerHTML = '‚úÖ OK';
                } else {
                    throw new Error(result.error?.message || 'No boards found. Ensure you created a board in your ' + (sandbox ? 'Sandbox' : 'Pinterest') + ' account.');
                }
            } catch (error) {
                console.error('Error loading boards:', error);
                if (statusDiv) {
                    statusDiv.innerHTML = '‚ùå Error: ' + error.message;
                    statusDiv.style.color = '#e53e3e';
                }
                if (btn) btn.innerHTML = '‚ùå';
            }
        }

        document.getElementById('btnLoadBoards').onclick = () => {
            const token = localStorage.getItem('pinterestToken');
            if (!token) return alert('Connect to Pinterest first!');
            loadPinterestBoards(token);
        };

        // Save active URL
        websiteUrlInput.addEventListener('input', function () {
            localStorage.setItem('pinterestGeneratorUrl', this.value);
        });

        // Preview file selections
        document.getElementById('image1').addEventListener('change', function (e) {
            previewFile(e.target.files[0], 'preview1', 'file1-name');
        });

        document.getElementById('image2').addEventListener('change', function (e) {
            previewFile(e.target.files[0], 'preview2', 'file2-name');
        });

        function previewFile(file, previewId, fileNameId) {
            if (!file) return;

            document.getElementById(fileNameId).textContent = file.name;

            const reader = new FileReader();
            reader.onload = function (e) {
                const previewDiv = document.getElementById(previewId);
                previewDiv.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const title = document.getElementById('title').value;
            const websiteUrl = document.getElementById('websiteUrl').value;
            const image1File = document.getElementById('image1').files[0];
            const image2File = document.getElementById('image2').files[0];

            if (!title || !image1File || !image2File) {
                alert('Please fill in all fields');
                return;
            }

            // Show loading
            generateBtn.disabled = true;
            loadingIndicator.style.display = 'block';
            resultSection.style.display = 'none';

            try {
                await generatePoster(title, websiteUrl, image1File, image2File);

                // Show result
                loadingIndicator.style.display = 'none';
                resultSection.style.display = 'block';

                // Scroll to result
                resultSection.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                alert('Error generating poster: ' + error.message);
                console.error(error);
            } finally {
                generateBtn.disabled = false;
            }
        });

        async function generatePoster(title, websiteUrl, image1File, image2File) {
            // Clear canvas
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Load images
            const img1 = await loadImage(image1File);
            const img2 = await loadImage(image2File);

            // Draw top image (0 to 750)
            drawImageCropped(img1, 0, 0, CANVAS_WIDTH, 750);

            // Draw bottom image (750 to 1500)
            drawImageCropped(img2, 0, 750, CANVAS_WIDTH, 750);

            // Draw banner
            const bannerY = (CANVAS_HEIGHT - BANNER_HEIGHT) / 2;
            drawBanner(bannerY, BANNER_HEIGHT);

            // Draw title and URL
            drawTitle(title, websiteUrl, bannerY, BANNER_HEIGHT);

            // Export to preview
            const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
            preview.src = dataUrl;
            downloadBtn.href = dataUrl;

            // Auto-trigger SEO Generation for preview
            generateSEOPreview(title);
        }

        async function generateSEOPreview(title) {
            const statusDiv = document.getElementById('postStatus');
            const seoTitleInput = document.getElementById('seoTitle');
            const seoDescInput = document.getElementById('seoDescription');
            const seoHashInput = document.getElementById('seoHashtags');

            statusDiv.style.color = '#4a5568';
            statusDiv.innerHTML = 'ü§ñ AI is writing SEO content for you...';

            try {
                const response = await fetch(`${window.location.origin}/api/generate-only`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        config: {
                            openrouter_key: localStorage.getItem('openrouterKey'),
                            openrouter_model: localStorage.getItem('openrouterModel'),
                            website_url: document.getElementById('websiteUrl').value
                        },
                        language: 'en'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    seoTitleInput.value = result.seoContent.title;
                    seoDescInput.value = result.seoContent.description;
                    seoHashInput.value = result.seoContent.hashtags.join(', ');

                    // Pre-fill the SEO link with the main website URL if empty
                    const mainUrl = document.getElementById('websiteUrl').value;
                    document.getElementById('seoLink').value = mainUrl.startsWith('http') ? mainUrl : `https://${mainUrl}`;

                    statusDiv.innerHTML = '‚úÖ SEO content ready! You can edit it if you want.';
                    statusDiv.style.color = '#38a169';
                }
            } catch (err) {
                statusDiv.innerHTML = '‚ùå AI error: ' + err.message;
                statusDiv.style.color = '#e53e3e';
            }
        }

        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Post Automatically Logic
        document.getElementById('postAutoBtn').addEventListener('click', async function () {
            const btn = this;
            const statusDiv = document.getElementById('postStatus');
            const imageData = preview.src;

            // Get EDITED values from the box
            const title = document.getElementById('seoTitle').value;
            const description = document.getElementById('seoDescription').value;
            const hashtags = document.getElementById('seoHashtags').value;
            const destinationLink = document.getElementById('seoLink').value;
            const websiteUrl = document.getElementById('websiteUrl').value;

            btn.disabled = true;
            btn.innerHTML = '‚è≥ Posting to Pinterest...';
            statusDiv.style.color = '#4a5568';
            statusDiv.innerHTML = 'üìå Sending to Pinterest...';

            const config = {
                openrouter_key: localStorage.getItem('openrouterKey'),
                pinterest_token: localStorage.getItem('pinterestToken'),
                pinterest_board: localStorage.getItem('pinterestBoard'),
                openrouter_model: localStorage.getItem('openrouterModel'),
                pinterest_app_id: localStorage.getItem('pinterestAppId'),
                pinterest_app_secret: localStorage.getItem('pinterestAppSecret'),
                pinterest_sandbox: localStorage.getItem('pinterestSandbox') === 'true',
                website_url: websiteUrl,
                language: 'en'
            };

            try {
                const response = await fetch(`${window.location.origin}/api/post-pin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageData,
                        title,
                        description,
                        hashtags,
                        websiteUrl: destinationLink, // Use the specific link
                        config
                    })
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.style.color = '#38a169';
                    statusDiv.innerHTML = `‚úÖ Successfully posted! <a href="${result.pinUrl}" target="_blank" style="color: #3182ce; text-decoration: underline;">View on Pinterest</a>`;
                    btn.innerHTML = '‚úÖ Posted!';
                    alert('Success! Your pin is live on Pinterest.');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusDiv.style.color = '#e53e3e';
                let msg = error.message;
                if (msg.includes('401') || msg.toLowerCase().includes('authentication') || msg.toLowerCase().includes('token')) {
                    msg = '<b>Authentication Failed:</b> Your session might have expired or scopes are missing. <br>üëâ Please go to <b>Settings ‚öôÔ∏è</b> and <b>Reconnect to Pinterest</b>.';
                }
                statusDiv.innerHTML = '‚ùå ' + msg;
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Post to Pinterest Now';
                console.error(error);
            }
        });


        function drawImageCropped(img, x, y, width, height) {
            const imgRatio = img.width / img.height;
            const targetRatio = width / height;

            let sx, sy, sWidth, sHeight;

            if (imgRatio > targetRatio) {
                // Image is wider - crop sides
                sHeight = img.height;
                sWidth = img.height * targetRatio;
                sx = (img.width - sWidth) / 2;
                sy = 0;
            } else {
                // Image is taller - crop top/bottom
                sWidth = img.width;
                sHeight = img.width / targetRatio;
                sx = 0;
                sy = (img.height - sHeight) / 2;
            }

            ctx.drawImage(img, sx, sy, sWidth, sHeight, x, y, width, height);
        }

        function drawBanner(y, height) {
            // Main white rectangle
            ctx.fillStyle = BANNER_COLOR;
            ctx.fillRect(0, y, CANVAS_WIDTH, height);

            // Add brush-stroke effect on edges
            ctx.fillStyle = BANNER_COLOR;

            // Top edge
            for (let x = 0; x < CANVAS_WIDTH; x += 20) {
                const offset = (hash(x + 1000) % 15) - 7;
                ctx.beginPath();
                ctx.arc(x, y + offset, 10, 0, Math.PI * 2);
                ctx.fill();
            }

            // Bottom edge
            for (let x = 0; x < CANVAS_WIDTH; x += 20) {
                const offset = (hash(x + 2000) % 15) - 7;
                ctx.beginPath();
                ctx.arc(x, y + height + offset, 10, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function hash(num) {
            let x = Math.sin(num) * 10000;
            return Math.floor((x - Math.floor(x)) * 1000);
        }

        function drawTitle(text, websiteUrl, bannerY, bannerHeight) {
            const titleUpper = text.toUpperCase();
            let fontSize = 90;
            const maxWidth = CANVAS_WIDTH * 0.85;
            const hasUrl = websiteUrl && websiteUrl.trim().length > 0;
            const userColor = document.getElementById('titleColor').value;

            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = userColor;

            // Try to fit text
            let lines = [titleUpper];
            let font = `${fontSize}px 'Knewave', cursive`;
            ctx.font = font;
            let metrics = ctx.measureText(titleUpper);

            // If too wide, split into 2 lines
            if (metrics.width > maxWidth) {
                const words = titleUpper.split(' ');
                if (words.length > 1) {
                    const mid = Math.ceil(words.length / 2);
                    lines = [
                        words.slice(0, mid).join(' '),
                        words.slice(mid).join(' ')
                    ];
                }

                // Reduce font size if still too wide
                while (fontSize > 40) {
                    font = `${fontSize}px 'Knewave', cursive`;
                    ctx.font = font;

                    const allFit = lines.every(line => ctx.measureText(line).width <= maxWidth);
                    if (allFit) break;

                    fontSize -= 5;
                }
            }

            // Calculate vertical positioning
            ctx.font = `${fontSize}px 'Knewave', cursive`;
            const lineHeight = fontSize * 1.2;
            const urlFontSize = 32;
            const urlSpace = hasUrl ? urlFontSize + 25 : 0;
            const totalHeight = lines.length * lineHeight + urlSpace;
            const centerY = bannerY + bannerHeight / 2;
            let yPos = centerY - totalHeight / 2 + lineHeight / 2;

            // Draw title lines
            lines.forEach(line => {
                // White stroke
                ctx.strokeStyle = BANNER_COLOR;
                ctx.lineWidth = 6;
                ctx.strokeText(line, CANVAS_WIDTH / 2, yPos);

                // Main text
                ctx.fillStyle = userColor;
                ctx.fillText(line, CANVAS_WIDTH / 2, yPos);

                yPos += lineHeight;
            });

            // Draw website URL in orange below the title
            if (hasUrl) {
                yPos += 10; // Add spacing between title and URL
                ctx.font = `bold ${urlFontSize}px Arial, sans-serif`;
                ctx.fillStyle = URL_COLOR;
                ctx.fillText(websiteUrl.trim(), CANVAS_WIDTH / 2, yPos);
            }
        }
    </script>
    </div> <!-- End mainContent -->
</body>

</html>